# PRETUS
**P**lug-in based, **Re**al-**t**ime **U**ltra**s**ound

---


This is a plug-in based, lightweight softwarefor real time image analysis, data collection, and operator guidance, developed within the [iFIND project](www.ifindproject.com).

## Contact
* Alberto Gomez (alberto.gomez@kcl.ac.uk)

## Contributors
* Alberto Gomez
* Nicolas Toussaint
* Gavin Wheeler
* Veronika Zimmer

# Summary

PRETUS is a lightweight software that creates, at run-time, a real-time imaging pipeline. The program itself does not do much on its own: most functionality is brought in through [plug-ins](src/Plugins) that are conected in sequence in the user-defined pipeline. Configuration information as well as data is passed from a plug-in to the next embedded in an object of the `the ifind::Image` class. This class, together with convenience readers and writers make up the [Common](src/Common) tools.

The software will load all plug-ins found in the plug-in folder (which can be defined through CMake with the variable ```PLUGIN_FOLDER```). Then, it will do the following operations in order:

1. Read from the command line the user-defined pipeline and re-order the plug-ins that will be used accordingly.
2. Connect each plug-in to the next. For each pair of connected plug-ins, two connections are made: first the configuration connection ( a plug-in can pass configuration parameters to the next); second, the real-time imaging connection (a plug-in will pass a processed image to the next, as they are processed).
3. All plug-ins are initialized (this normally triggers object creation, loading default values, models, etc).
4. All plug-ins are activated (this triggers the actual processing pipeline)

Once the initialization is complete, each plugin passes, in turn, the image generated by the predecessor plug-in to the next. Plug-ins can execute their task every time a new image is available, or at a given frame-rata. Individual maximum frame rates for each individual plug-in can be tuned separately.

# Usage

The available plug-ins can be checked with the `-h` flag:
```bash
$ pretus -h
```
which will give an example output (this varies depending on the available plug-ins) like:
```
$ pretus -h
Loading plug-ins
	0 [Plugin] loading <plug-ins folder>/libPlugin_visualization.so...	Plugin visualization(0) successfully loaded
	1 [Plugin] loading <plug-ins folder>/libPlugin_filenamanager.so...	Plugin File manager(1) successfully loaded

pretus [-h]
Optional arguments:
	-h 	Show this help.
	-pipeline <int>	String with the pipeline to carry out.
		Examples of pipeline strings
		pretus -pipeline "1>0"	Loads from file and visualizes

# PLUGIN Plugin visualization
	Additional arguments:
		-timerinterval <val>	Value (in ms) between displayed frames. Default: 40
		-showruler <0/1>	Whether to show (1) or not (0) a ruler. Default: 0
		-layer <number of layer>	Display (if available) the requested layer. Default: 0
		-overlay <0/1>	Activate (1) or desactivate (0) displaying multiple layers as overlay. Default: 0


# PLUGIN Plugin File manager
	Additional arguments:
		-fr <frame rate>	frame rate
		-noloop 	Do not loop around. Default: loop around
		-input_folder <path to folder>	Take images from a folder. Default: current folder
```

# Plug-ins

Functionality is brought in via plug-ins. Al plug-ins must inherit the class `Plugin` in the [PluginLib](src/PluginLib) library.

Please checkout the documentation for each plug-in in terms of dependencies, build instructions, etc.

# Build instructions

## Dependencies

The minimum requirements are:

* CMake 3.15
* Qt 5 
    * tested with 5.12
* VTK 
    * Tested with 8.2.0 (Recommended to set the `VTK_LEGACY_SILENT` CMake flag to `ON`)
* ITK (for the webcam plug-in, built with the `ITKVideoBridgeOpencv` option `ON`)
    * Tested with 4.9.1
    * HDF5 enabled (tip on this later)
* OpenCV and OpenCV contrib
    * Tested with 3.4.4
* Boost
    * Tested with 1.71.0
* gcc
    * Tested with 8.4.0
* Anaconda
    * Testing with 2020.02

## Other dependencies (some plug-ins)
* For the plug-ins that require OpenCV, you will need also Opencv_contrib. We suggest following [this guide](https://www.learnopencv.com/install-opencv3-on-ubuntu/).

## Brief build and install

1. Launch CMake configure. CMake needs to be able to find (automatically if installed systemwide, or specifying the build directories otherwise) the following packages:
    * VTK
    * ITK
    * QT (should be the same version used for VTK)
    * OpenCV
    * Boost
At this stage you can enable and disable what plug-ins will be built. See plug-in specific instructions on how to configure CMake options for them.
2. [Optional] If you have external plug-ins built somewhere else, you need to specify the plug-ins build folder in the CMake entry `PLUGIN_FOLDER`. These can be more than one folder, separated by `;`.
3. Generate.  At this stage, you may bet some errors or warnings. If there is an error about conflicting library versions with conda, make sure you select the anaconda versions on CMake.
4. make.
5. And launch `iFIND2Standalone -h`.

More comprehensive instrunctions, and troubleshooting, can be found [here](src/troubleshooting.md).


# Acknowledgement 

This work was supported by the Wellcome Trust IEH Award [102431], by the Wellcome/EPSRC Centre for Medical Engineering [WT203148/Z/16/Z] and by the National Institute for Health Research (NIHR) Biomedical Research Centre at Guy's and St Thomas' NHS Foundation Trust and King's College London. The views expressed are those of the author(s) and not necessarily those of the NHS, the NIHR or the Department of Health.
