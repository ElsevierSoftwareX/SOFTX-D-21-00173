# PRETUS
**P**lug-in based, **Re**al-**t**ime **U**ltra**s**ound

---


This is a plug-in based, lightweight software for real time image analysis, data collection, and operator guidance, developed within the [iFIND project](www.ifindproject.com).

If you use PRETUS please cite [our preprint](https://arxiv.org/abs/2109.06519):

[Alberto Gomez, Veronika A. Zimmer, Gavin Wheeler, Nicolas Toussaint, Shujie Deng, Robert Wright, Emily Skelton, Jackie Matthew, Bernhard Kainz, Jo Hajnal, Julia Schnabel. "PRETUS: A plug-in based platform for real-time ultrasound imaging research", 2021 - arXiv:2109.0651](https://arxiv.org/abs/2109.06519)

## Contact
* Alberto Gomez (alberto.gomez@kcl.ac.uk)

## Contributors
* Alberto Gomez
* Nicolas Toussaint
* Gavin Wheeler
* Veronika Zimmer

# Summary

PRETUS is a lightweight software that creates, at run-time, a real-time imaging pipeline. The program itself does not do much on its own: most functionality is brought in through [plug-ins](src/Plugins) that are conected in sequence in the user-defined pipeline. Configuration information as well as data is passed from a plug-in to the next embedded in an object of the `the ifind::Image` class. This class, together with convenience readers and writers make up the [Common](src/Common) tools.

The software will load all plug-ins found in the plug-in folder. Such folder can be given a default value at build time (defined through CMake with the variable ```PLUGIN_FOLDER```), or can be set at any time in the config file ```<$HOME>/.config/iFIND/PRETUS.conf``` (if multiple folders, they can be colon-separated). Then, it will do the following operations in order:

1. Read from the command line the user-defined pipeline and re-order the plug-ins that will be used accordingly.
2. Connect each plug-in to the next. For each pair of connected plug-ins, two connections are made: first the configuration connection ( a plug-in can pass configuration parameters to the next); second, the real-time imaging connection (a plug-in will pass a processed image to the next, as they are processed).
3. All plug-ins are initialized (this normally triggers object creation, loading default values, models, etc).
4. All plug-ins are activated (this triggers the actual processing pipeline)

Once the initialization is complete, each plugin passes, in turn, the image generated by the predecessor plug-in to the next. Plug-ins can execute their task every time a new image is available, or at a given frame-rata. Individual maximum frame rates for each individual plug-in can be tuned separately.

# Usage

The available plug-ins can be checked with the `-h` flag:

```bash
$ pretus -h
```

which will give an example output (this varies depending on the available plug-ins) like:

```
$ pretus -h
Loading plug-ins from <PLUGINS_FOLDER>
	0 [Plugin] loading <PLUGINS_FOLDER>/libPlugin_filemanager.so...	File manager(0) loaded
	1 [Plugin] loading <PLUGINS_FOLDER>/libPlugin_imageFileWriter.so...	Image file writer(1) loaded
	2 [Plugin] loading <PLUGINS_FOLDER>/libPlugin_videomanager.so...	Video manager(2) loaded
	3 [Plugin] loading <PLUGINS_FOLDER>/libPlugin_CppAlgorithm.so...	Cpp Algorithm(3) loaded
	4 [Plugin] loading <PLUGINS_FOLDER>/libPlugin_framegrabber.so...	Frame grabber(4) loaded
	5 [Plugin] loading <PLUGINS_FOLDER>/libPlugin_PythonAlgorithm.so...	Python Algorithm(5) loaded
	6 [Plugin] loading <PLUGINS_FOLDER>/libPlugin_planeDetection.so...	Standard plane detection(6) loaded
	7 [Plugin] loading <PLUGINS_FOLDER>/libPlugin_GUI.so...	GUI(7) loaded
<HOME>/local/bin/pretus [-h]
Optional arguments:
	-h 	Show this help.

	-pipeline <val> :
		-pipeline "index>index...>index" [-plugin_option value -plugin_option value ...]
	or...
		-pipeline "plugin_name>plugin_name" -plugin_option value -plugin_option value
			Where 'plugin_name' comparison is case and space insensitive

	Examples of pipeline strings
	/home/ag09/local/iFIND/bin/pretus -pipeline "3>1>0"
	/home/ag09/local/iFIND/bin/pretus -pipeline "FileManager>GUI" --filemanager_input "some_path"



(0) Plugin Name: 'File manager'

# PLUGIN File manager
   Reads and transmits images from a folder hierarchy.
	--filemanager_framerate <val> [ type: FLOAT]	Frame rate at which the plugin does the work. (Default: 20) 
	--filemanager_verbose <val> [ type: BOOL]	Whether to print debug information (1) or not (0). (Default: 0) 
	--filemanager_showimage <val> [ type: INT]	Whether to display realtime image outputs in the central window (1) or not (0). 
                                           		(Default: <1 for input plugins, 0 for the rest>) 
	--filemanager_showwidget <val> [ type: INT]	Whether to display widget with plugin information (1-4) or not (0). Location is 
                                            		1- top left, 2- top right, 3-bottom left, 4-bottom right. (Default: visible, 
                                            		default location depends on widget.) 
   Plugin-specific arguments:
	--filemanager_loop <val> [ type: INT]	loop around (1) or not (0). (Default: 0) 
	--filemanager_asraw <val> [ type: INT]	Load the data as raw (1), without any preprovcessing available in the header 
                                       		(0). (Default: 0) 
	--filemanager_checkMhdConsistency <val> [ type: INT]	Check that data is consistent and ignore inconsistent files (1) or not (0). 
                                                     		(Default: 1) 
	--filemanager_input <path to folder> [ type: STRING]	Take images from a folder. (Default: Currentfolder) 

(1) Plugin Name: 'Image file writer'

# PLUGIN Image file writer
   Save image data to the file system.
	--imagefilewriter_stream <val> [ type: STRING]	Name of the stream(s) that this plug-in takes as input. (Default: ) 
	--imagefilewriter_framerate <val> [ type: FLOAT]	Frame rate at which the plugin does the work. (Default: 20) 
	--imagefilewriter_verbose <val> [ type: BOOL]	Whether to print debug information (1) or not (0). (Default: 0) 
	--imagefilewriter_time <val> [ type: BOOL]	Whether to measure execution time (1) or not (0). (Default: 0) 
	--imagefilewriter_showwidget <val> [ type: INT]	Whether to display widget with plugin information (1-4) or not (0). Location is 
                                                		1- top left, 2- top right, 3-bottom left, 4-bottom right. (Default: visible, 
                                                		default location depends on widget.) 
   Plugin-specific arguments:
	--imagefilewriter_folder <folder> [ type: STRING]	Parent folder to save images. Will be created if does not exist. (Default: ) 
	--imagefilewriter_stream <stream name> [ type: STRING]	Write images only of a certain stream type, given as a string. If set to "-", it 
                                                       		saves all. (Default: Input) 
	--imagefilewriter_maxfiles <N> [ type: INT]	Maximum number of images in a single folder, will create another folder if this 
                                            		is exceeded. If 0, all files in same folder. (Default: 0) 
	--imagefilewriter_firstsubdivision <N> [ type: INT]	Initial id for the subdivision folder. (Default: 0) 

(2) Plugin Name: 'Video manager'

# PLUGIN Video manager
   Reads video files from disk. File format depends on opencv installation.
	--videomanager_framerate <val> [ type: FLOAT]	Frame rate at which the plugin does the work. (Default: 20) 
	--videomanager_verbose <val> [ type: BOOL]	Whether to print debug information (1) or not (0). (Default: 0) 
	--videomanager_showimage <val> [ type: INT]	Whether to display realtime image outputs in the central window (1) or not (0). 
                                            		(Default: <1 for input plugins, 0 for the rest>) 
	--videomanager_showwidget <val> [ type: INT]	Whether to display widget with plugin information (1-4) or not (0). Location is 
                                             		1- top left, 2- top right, 3-bottom left, 4-bottom right. (Default: visible, 
                                             		default location depends on widget.) 
   Plugin-specific arguments:
	--videomanager_loop <val> [ type: INT]	loop around (1) or not (0). (Default: 1) 
	--videomanager_ff <fast forward factor> [ type: FLOAT]	Fast forward factor, in (0, inf). 1 means native speed, >1 is faster, <1 is 
                                                       		slower. (Default: 1.1) 
	--videomanager_starttime <mm:ss> [ type: STRING]	Initial time to start getting frames from the video. (Default: 00:00) 
	--videomanager_input <path to video> [ type: STRING]	Take images from a video file. (Default: N/A (compulsory)) 

(3) Plugin Name: 'Cpp Algorithm'

# PLUGIN Cpp Algorithm
   Sample plug-in that does a simple threshold based segmentation.
	--cppalgorithm_stream <val> [ type: STRING]	Name of the stream(s) that this plug-in takes as input. (Default: ) 
	--cppalgorithm_layer <val> [ type: INT]	Number of the input layer to pass to the processing task. If negative, starts 
                                        		from te end. (Default: 0) 
	--cppalgorithm_framerate <val> [ type: FLOAT]	Frame rate at which the plugin does the work. (Default: 20) 
	--cppalgorithm_verbose <val> [ type: BOOL]	Whether to print debug information (1) or not (0). (Default: 0) 
	--cppalgorithm_time <val> [ type: BOOL]	Whether to measure execution time (1) or not (0). (Default: 0) 
	--cppalgorithm_showimage <val> [ type: INT]	Whether to display realtime image outputs in the central window (1) or not (0). 
                                            		(Default: <1 for input plugins, 0 for the rest>) 
	--cppalgorithm_showwidget <val> [ type: INT]	Whether to display widget with plugin information (1-4) or not (0). Location is 
                                             		1- top left, 2- top right, 3-bottom left, 4-bottom right. (Default: visible, 
                                             		default location depends on widget.) 
   Plugin-specific arguments:
	--cppalgorithm_threshold <val> [ type: INT]	Intensity threshold for segmentation. (Default: 50) 

(4) Plugin Name: 'Frame grabber'

# PLUGIN Frame grabber
   Reads real-time imaging from a video source using the Epiphan DVI2USB 3.0  grabber.
	--framegrabber_framerate <val> [ type: FLOAT]	Frame rate at which the plugin does the work. (Default: 20) 
	--framegrabber_verbose <val> [ type: BOOL]	Whether to print debug information (1) or not (0). (Default: 0) 
	--framegrabber_showimage <val> [ type: INT]	Whether to display realtime image outputs in the central window (1) or not (0). 
                                            		(Default: <1 for input plugins, 0 for the rest>) 
	--framegrabber_showwidget <val> [ type: INT]	Whether to display widget with plugin information (1-4) or not (0). Location is 
                                             		1- top left, 2- top right, 3-bottom left, 4-bottom right. (Default: visible, 
                                             		default location depends on widget.) 
   Plugin-specific arguments:
	--framegrabber_studioswing <val> [ type: BOOL]	Correct for studio swing (1) or not (0). (Default: 1) 
	--framegrabber_resolution <val> [ type: FLOAT]	Value, in mm, of the pixel size (isotropic). (Default: 1) 

(5) Plugin Name: 'Python Algorithm'

# PLUGIN Python Algorithm
   Sample plug-in that does a simple Gaussian blurring.
	--pythonalgorithm_stream <val> [ type: STRING]	Name of the stream(s) that this plug-in takes as input. (Default: ) 
	--pythonalgorithm_layer <val> [ type: INT]	Number of the input layer to pass to the processing task. If negative, starts 
                                           		from te end. (Default: 0) 
	--pythonalgorithm_framerate <val> [ type: FLOAT]	Frame rate at which the plugin does the work. (Default: 20) 
	--pythonalgorithm_verbose <val> [ type: BOOL]	Whether to print debug information (1) or not (0). (Default: 0) 
	--pythonalgorithm_time <val> [ type: BOOL]	Whether to measure execution time (1) or not (0). (Default: 0) 
	--pythonalgorithm_showimage <val> [ type: INT]	Whether to display realtime image outputs in the central window (1) or not (0). 
                                               		(Default: <1 for input plugins, 0 for the rest>) 
	--pythonalgorithm_showwidget <val> [ type: INT]	Whether to display widget with plugin information (1-4) or not (0). Location is 
                                                		1- top left, 2- top right, 3-bottom left, 4-bottom right. (Default: visible, 
                                                		default location depends on widget.) 
   Plugin-specific arguments:
	--pythonalgorithm_sigma <val> [ type: FLOAT]	Sigma (in mm) for Gaussian blurring. (Default: 3) 
	--pythonalgorithm_delay <val> [ type: FLOAT]	Delay (in sec) for artificially slowing doen the execution. (Default: 0) 

(6) Plugin Name: 'Standard plane detection'

# PLUGIN Standard plane detection
   Standard plane detection using SonoNet by Baumgartner et al.
	--standardplanedetection_stream <val> [ type: STRING]	Name of the stream(s) that this plug-in takes as input. (Default: ) 
	--standardplanedetection_layer <val> [ type: INT]	Number of the input layer to pass to the processing task. If negative, starts 
                                                  		from te end. (Default: 0) 
	--standardplanedetection_framerate <val> [ type: FLOAT]	Frame rate at which the plugin does the work. (Default: 20) 
	--standardplanedetection_verbose <val> [ type: BOOL]	Whether to print debug information (1) or not (0). (Default: 0) 
	--standardplanedetection_time <val> [ type: BOOL]	Whether to measure execution time (1) or not (0). (Default: 0) 
	--standardplanedetection_showimage <val> [ type: INT]	Whether to display realtime image outputs in the central window (1) or not (0). 
                                                      		(Default: <1 for input plugins, 0 for the rest>) 
	--standardplanedetection_showwidget <val> [ type: INT]	Whether to display widget with plugin information (1-4) or not (0). Location is 
                                                       		1- top left, 2- top right, 3-bottom left, 4-bottom right. (Default: visible, 
                                                       		default location depends on widget.) 
   Plugin-specific arguments:
	--standardplanedetection_taverage <val> [ type: INT]	Number of frames used for a temporal average of the detection. (Default: 0) 
	--standardplanedetection_modelname <*.pth> [ type: STRING]	Model file name (without folder). (Default: ifind2_net_Jan15.pth) 
	--standardplanedetection_bckth <val> [ type: FLOAT]	Min value for background to be considered; below this value, background will be 
                                                    		ignored and second best picked. Range is [0.0, 1.0] If -1, ths flag is not used. 
                                                    		(Default: -1) 
	--standardplanedetection_savebck <0/1> [ type: INT]	Whether to save background images to file (1, in this stream) or not (0). 
                                                    		(Default: 0) 

(7) Plugin Name: 'GUI'

# PLUGIN GUI
   Displays imaging and non-imaging data in real time.
	--gui_framerate <val> [ type: FLOAT]	Frame rate at which the plugin does the work. (Default: 20) 
	--gui_verbose <val> [ type: BOOL]	Whether to print debug information (1) or not (0). (Default: 0) 
	--gui_time <val> [ type: BOOL]	Whether to measure execution time (1) or not (0). (Default: 0) 
```

# Plug-ins

Functionality is brought in via plug-ins. Al plug-ins must inherit the class `Plugin` in the [PluginLib](src/PluginLib) library.

Please checkout the documentation for each plug-in in terms of dependencies, build instructions, etc.

# Build instructions

## Dependencies

The minimum requirements are:

* CMake 3.15
* Qt 5 
    * tested with 5.12
* VTK 
    * Tested with 8.2.0 (Recommended to set the `VTK_LEGACY_SILENT` CMake flag to `ON`)
* ITK (for the video manager plug-in, built with the `ITKVideoBridgeOpencv` option `ON`)
    * Tested with 4.9.1
    * HDF5 enabled (tip on this later)
* OpenCV and OpenCV contrib
    * Tested with 3.4.4
* Boost
    * Tested with 1.71.0
* gcc
    * Tested with 8.4.0
* Anaconda
    * Testing with 2020.02

## Other dependencies (some plug-ins)
* For the plug-ins that require OpenCV, you will need also Opencv_contrib. We suggest following [this guide](https://www.learnopencv.com/install-opencv3-on-ubuntu/).

## Brief build and install

1. Launch CMake configure. CMake needs to be able to find (automatically if installed systemwide, or specifying the build directories otherwise) the following packages:
    * VTK (Recommended to set the `VTK_LEGACY_SILENT` CMake flag to `ON`)
    * ITK (for the video manager plug-in, built with the `ITKVideoBridgeOpencv` option `ON`)
    * QT (should be the same version used for VTK)
    * OpenCV (needed for ITK - build with opencv contrib as decribed above)
    * Boost
At this stage you can enable and disable what plug-ins will be built. See plug-in specific instructions on how to configure CMake options for them.
2. [Optional] If you have external plug-ins built somewhere else, you need to specify the plug-ins build folder in the CMake entry `PLUGIN_FOLDER`. These can be more than one folder, separated by `;`. These folders can also be set after build in the config file (```<$HOME>/.config/iFIND/PRETUS.conf```).
3. Set your install path using the `CMAKE_INSTALL_PREFIX` variable. We recommend a path within `<HOME>/local/`.
4. Select the plug-ins to build with `BUILD_PLUGIN_XXX`. We recommend to initially build with the default enabled plug-ins, and gradually build the rest.
**Each plug-in has different dependencies, so please do check the README in each Plug-in folder for specific build instructions.**
5. Generate.  At this stage, you *might* get some errors or warnings. If there is an error about conflicting library versions with conda, make sure you select the anaconda versions on CMake.
6. `make`, and `make install`. The `install` step is mandatory for if you use Python plug-ins (else PRETUS will not find the python sources)
5. And launch `pretus -h`.

More comprehensive instructions, and troubleshooting, can be found [here](src/troubleshooting.md).


# Acknowledgement 

This work was supported by the Wellcome Trust IEH Award [102431], by the Wellcome/EPSRC Centre for Medical Engineering [WT203148/Z/16/Z] and by the National Institute for Health Research (NIHR) Biomedical Research Centre at Guy's and St Thomas' NHS Foundation Trust and King's College London. The views expressed are those of the author(s) and not necessarily those of the NHS, the NIHR or the Department of Health.
